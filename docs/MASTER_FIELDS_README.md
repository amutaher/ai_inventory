# AI Sales Dashboard Master Fields Fix

## Overview
This fix adds missing Customer and Item master fields to the AI Sales Dashboard report, specifically:
- **Customer Master**: Churn Probability (%)
- **Item Master**: Forecasted Qty (Next 30 Days)

## Files Created/Updated

### 1. Custom Field Definitions
- `ai_inventory/custom/customer.json` - Customer custom fields
- `ai_inventory/custom/item.json` - Item custom fields
- `ai_inventory/fixtures/custom_field.json` - Updated fixtures with all custom fields

### 2. Migration & Patches
- `ai_inventory/patches/v1_0/add_master_analytics_fields.py` - Migration patch
- `ai_inventory/patches.txt` - Updated with new patch

### 3. Report Updates
- `ai_inventory/report/ai_sales_dashboard/ai_sales_dashboard.py` - Updated to include master fields

### 4. Execution Scripts
- `FINAL_MASTER_FIELDS_FIX.py` - Manual execution guide
- `complete_master_fields_fix.py` - Comprehensive fix script

## Installation Steps

### Step 1: Add Database Columns
Execute these SQL commands in your database:

```sql
-- Add Customer Analytics Fields
ALTER TABLE `tabCustomer` ADD COLUMN IF NOT EXISTS `churn_probability` DECIMAL(8,2) DEFAULT 0.00;
ALTER TABLE `tabCustomer` ADD COLUMN IF NOT EXISTS `customer_lifetime_value` DECIMAL(18,2) DEFAULT 0.00;
ALTER TABLE `tabCustomer` ADD COLUMN IF NOT EXISTS `last_analytics_update` DATETIME NULL;

-- Add Item Analytics Fields
ALTER TABLE `tabItem` ADD COLUMN IF NOT EXISTS `forecasted_qty_30_days` DECIMAL(18,2) DEFAULT 0.00;
ALTER TABLE `tabItem` ADD COLUMN IF NOT EXISTS `demand_pattern` VARCHAR(140) DEFAULT 'Unknown';
ALTER TABLE `tabItem` ADD COLUMN IF NOT EXISTS `last_forecast_update` DATETIME NULL;

-- Populate Customer Analytics (Sample Data)
UPDATE `tabCustomer` c
SET 
    churn_probability = CASE 
        WHEN EXISTS(SELECT 1 FROM `tabSales Invoice` si WHERE si.customer = c.name AND si.docstatus = 1 AND si.posting_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)) THEN 15.0
        WHEN EXISTS(SELECT 1 FROM `tabSales Invoice` si WHERE si.customer = c.name AND si.docstatus = 1 AND si.posting_date >= DATE_SUB(CURDATE(), INTERVAL 180 DAY)) THEN 35.0
        ELSE 75.0
    END,
    customer_lifetime_value = COALESCE((SELECT SUM(grand_total) FROM `tabSales Invoice` si WHERE si.customer = c.name AND si.docstatus = 1), 0),
    last_analytics_update = NOW()
WHERE c.disabled = 0;

-- Populate Item Analytics (Sample Data)
UPDATE `tabItem` i
SET 
    forecasted_qty_30_days = COALESCE((
        SELECT AVG(sii.qty) * 1.2
        FROM `tabSales Invoice Item` sii
        INNER JOIN `tabSales Invoice` si ON si.name = sii.parent
        WHERE sii.item_code = i.name AND si.docstatus = 1 
        AND si.posting_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
    ), 0),
    demand_pattern = CASE 
        WHEN EXISTS(SELECT 1 FROM `tabSales Invoice Item` sii INNER JOIN `tabSales Invoice` si ON si.name = sii.parent WHERE sii.item_code = i.name AND si.docstatus = 1 AND si.posting_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) THEN 'High Demand'
        WHEN EXISTS(SELECT 1 FROM `tabSales Invoice Item` sii INNER JOIN `tabSales Invoice` si ON si.name = sii.parent WHERE sii.item_code = i.name AND si.docstatus = 1 AND si.posting_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)) THEN 'Moderate'
        ELSE 'Low Demand'
    END,
    last_forecast_update = NOW()
WHERE i.disabled = 0 AND i.is_sales_item = 1;
```

### Step 2: Apply Migration
From your frappe-bench directory, run:
```bash
bench migrate
```

OR manually execute the patch:
```bash
bench execute ai_inventory.patches.v1_0.add_master_analytics_fields.execute
```

### Step 3: Restart System
```bash
bench restart
```

### Step 4: Verify Installation

#### Customer Master Verification
1. Go to Customer List
2. Open any customer record
3. Check for these new fields:
   - **Churn Probability (%)** - Shows calculated churn risk
   - **Customer Lifetime Value** - Shows total revenue from customer
   - **Last Analytics Update** - Shows when analytics were last calculated

#### Item Master Verification
1. Go to Item List
2. Open any sales item record
3. Check for these new fields:
   - **Forecasted Qty (Next 30 Days)** - Shows AI-calculated forecast
   - **Demand Pattern** - Shows demand classification
   - **Last Forecast Update** - Shows when forecast was last updated

#### AI Sales Dashboard Verification
1. Go to Reports > AI Sales Dashboard
2. Verify these columns are visible:
   - **Customer Churn Probability (%)** - From Customer master
   - **Item Forecasted Qty (Next 30 Days)** - From Item master
   - All other existing analytics fields

## Field Descriptions

### Customer Master Fields
- **Churn Probability (%)**: AI-calculated probability that the customer will stop buying (0-100%)
- **Customer Lifetime Value**: Total revenue generated by the customer
- **Last Analytics Update**: Timestamp of last analytics calculation

### Item Master Fields
- **Forecasted Qty (Next 30 Days)**: AI-predicted quantity to be sold in next 30 days
- **Demand Pattern**: Classification of demand (Stable, High Demand, Moderate, Low Demand, etc.)
- **Last Forecast Update**: Timestamp of last forecast calculation

## Dashboard Integration

The AI Sales Dashboard report now includes:
1. **Direct Master Integration**: Fields pulled directly from Customer and Item masters
2. **Error Handling**: Graceful fallback if master fields are missing
3. **Real-time Data**: Always shows current master field values
4. **Enhanced Analytics**: Combined forecast and master data for comprehensive insights

## Troubleshooting

### Issue: Fields not showing in masters
**Solution**: Run the migration patch manually:
```bash
bench execute ai_inventory.patches.v1_0.add_master_analytics_fields.execute
```

### Issue: Dashboard columns empty
**Solution**: Ensure database columns exist and run data population:
```bash
# Check if columns exist
bench mariadb
DESCRIBE tabCustomer;
DESCRIBE tabItem;
```

### Issue: Custom fields not visible
**Solution**: Clear cache and restart:
```bash
bench clear-cache
bench restart
```

### Issue: Analytics not calculating
**Solution**: Run AI forecast updates:
1. Go to AI Sales Forecast list
2. Select records and click "Run AI Forecast"
3. Check that analytics are being calculated and saved

## Support

If you encounter issues:
1. Check the Error Log in ERPNext
2. Verify all SQL commands executed successfully
3. Ensure migration patch ran without errors
4. Confirm custom fields are installed in DocType customizations
5. Verify the AI Sales Dashboard report query includes the new fields

## Next Steps

After successful installation:
1. **Train Users**: Show them the new fields in Customer and Item masters
2. **Monitor Analytics**: Ensure the AI calculations are running and updating fields
3. **Optimize Performance**: Monitor report performance with the additional joins
4. **Enhance Logic**: Improve the analytics calculation logic based on business needs

---

**Installation Complete!** âœ…

The AI Sales Dashboard now displays Customer Churn Probability and Item Forecasted Qty from the respective master records, providing comprehensive analytics in a single view.
